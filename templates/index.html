<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistent Of Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Product+Sans:wght@400;700&display=swap');

        body {
            font-family: 'Product Sans', Arial, sans-serif;
            overflow-x: hidden;
        }

        /* Animación de carga */
        .dot-flashing {
            position: relative;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #3b82f6;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: .5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #3b82f6;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 15px;
            width: 10px;
            height: 10px;
            border-radius: 5px;
            background-color: #3b82f6;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 1s;
        }

        @keyframes dot-flashing {
            0% { background-color: #3b82f6; }
            50%, 100% { background-color: #ebebeb; }
        }

        .bg-gradient-custom {
            background: radial-gradient(circle at 50% 50%, #ffffff 0%, #f9fafb 100%);
        }
    </style>
</head>

<body class="bg-gradient-custom min-h-screen flex flex-col items-center p-6">

    <header class="mt-10 mb-8 text-center select-none transform transition-all hover:scale-105 duration-500">
        <h1 class="text-5xl md:text-7xl font-bold tracking-tighter">
            <span class="text-blue-500">A</span><span class="text-red-500">s</span><span
                class="text-yellow-500">i</span><span class="text-blue-500">s</span><span
                class="text-green-500">t</span><span class="text-red-500">e</span><span class="text-gray-700">nt</span>
        </h1>
        <p class="text-lg text-gray-400 font-light mt-2 tracking-widest uppercase">Of Search</p>
    </header>

    <div class="w-full max-w-2xl z-10">
        <div class="group relative flex items-center border border-gray-200 rounded-full px-6 py-4 hover:shadow-xl focus-within:shadow-xl focus-within:border-blue-300 transition-all duration-300 bg-white">
            <input type="text" id="userInput" placeholder="Ej: Arduino Uno, Sensor ultrasonido..."
                class="flex-grow outline-none text-lg text-gray-700 bg-transparent placeholder-gray-400" 
                onkeypress="handleKeyPress(event)">
            <button onclick="sendQuery()"
                class="ml-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full font-bold transition-all transform active:scale-95 shadow-md">
                Enviar
            </button>
        </div>
    </div>

    <div id="loadingIndicator" class="hidden mt-8">
        <div class="dot-flashing"></div>
    </div>

    <main class="w-full max-w-6xl mt-8">
        
        <div id="resultBox" class="hidden mb-8 p-6 bg-white rounded-2xl border border-gray-100 shadow-sm text-center">
            <p id="responseText" class="text-gray-800 text-lg"></p>
        </div>

        <div id="cardsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
            </div>

    </main>

    <footer class="mt-auto py-6 text-gray-400 text-sm text-center">
        &copy; 2026 Asistent Of Search - Potenciado por Python FastAPI
    </footer>

    <script>
        function handleKeyPress(e) {
            if (e.key === 'Enter') sendQuery();
        }

        async function sendQuery() {
            const input = document.getElementById('userInput');
            const resultBox = document.getElementById('resultBox');
            const responseText = document.getElementById('responseText');
            const cardsContainer = document.getElementById('cardsContainer');
            const loading = document.getElementById('loadingIndicator');
            
            const message = input.value.trim();
            if (!message) return;

            // 1. Preparar UI (Limpiar anterior y mostrar carga)
            resultBox.classList.add('hidden');
            cardsContainer.innerHTML = ''; // Limpiar tarjetas viejas
            loading.classList.remove('hidden');
            input.disabled = true;

            try {
                // 2. Petición al Backend
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                // 3. Ocultar carga y mostrar resultados
                loading.classList.add('hidden');
                
                // Mostrar mensaje resumen
                resultBox.classList.remove('hidden');
                responseText.innerText = data.reply || "Respuesta recibida";

                // 4. Renderizar tarjetas si hay resultados
                if (data.results) {
                    renderCards(data.results);
                }

            } catch (error) {
                loading.classList.add('hidden');
                resultBox.classList.remove('hidden');
                responseText.innerHTML = `<span class="text-red-500 font-bold">Error:</span> No pude conectar con main.py. <br>Asegúrate de que el servidor Python esté corriendo.`;
                console.error(error);
            } finally {
                input.disabled = false;
                input.focus();
            }
        }

        function renderCards(resultadosAgrupados) {
            const container = document.getElementById('cardsContainer');
            
            // Recorremos las tiendas (Vistronica, Electronilab)
            for (const [nombreTienda, productos] of Object.entries(resultadosAgrupados)) {

                // Si la tienda no trajo productos, no mostramos tarjeta vacía
                if (!productos || productos.length === 0) continue;

                // Estilos dinámicos según la tienda
                const isVistronica = nombreTienda === 'Vistronica';
                // Vistronica = Naranja, Electronilab = Azul
                const headerColor = isVistronica ? 'bg-orange-500' : 'bg-blue-600';
                const badgeColor = isVistronica ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800';
                const borderColor = isVistronica ? 'border-orange-200' : 'border-blue-200';

                // Generar lista de items HTML
                let itemsHTML = productos.map(p => `
                <li class="flex items-start p-4 border-b border-gray-100 last:border-0 hover:bg-gray-50 transition-colors duration-150">
                    <div class="flex-shrink-0 w-12 h-12 border border-gray-200 rounded-lg overflow-hidden bg-white p-1">
                        <img src="${p.imagen || 'https://via.placeholder.com/48?text=N/A'}" 
                             alt="img" class="w-full h-full object-contain">
                    </div>
                    <div class="ml-4 flex-1">
                        <a href="${p.url}" target="_blank" class="text-sm font-semibold text-gray-900 hover:text-blue-600 hover:underline leading-snug block mb-1">
                            ${p.nombre}
                        </a>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-bold text-gray-800">${p.precio}</span>
                            <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">
                                Stock: ${p.stock || '?'}
                            </span>
                        </div>
                    </div>
                </li>
                `).join('');

                // Generar la Tarjeta Principal de la Tienda
                const storeCardHTML = `
                <div class="bg-white rounded-2xl shadow-xl border ${borderColor} overflow-hidden flex flex-col h-full transform transition-all hover:-translate-y-1 hover:shadow-2xl">
                    <div class="${headerColor} px-5 py-4 flex justify-between items-center text-white">
                        <h3 class="font-bold text-xl tracking-wide flex items-center gap-2">
                             ${nombreTienda}
                        </h3>
                        <span class="bg-white/25 text-white text-xs font-bold px-3 py-1 rounded-full backdrop-blur-sm">
                            ${productos.length} items
                        </span>
                    </div>

                    <div class="overflow-y-auto max-h-[500px] scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent">
                        <ul class="divide-y divide-gray-50">
                            ${itemsHTML}
                        </ul>
                    </div>

                    <div class="bg-gray-50 p-3 text-center border-t border-gray-100">
                        <a href="#" class="text-xs text-gray-400 hover:text-gray-600 transition-colors">Ver más en ${nombreTienda}</a>
                    </div>
                </div>
                `;

                container.insertAdjacentHTML('beforeend', storeCardHTML);
            }
        }
    </script>
</body>
</html>