<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asistent Of Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-start: #05070f;
            --bg-end: #11172a;
            --neon-cyan: #78ecff;
            --neon-blue: #63d2ff;
            --neon-purple: #ca76ff;
            --panel: rgba(7, 10, 24, 0.82);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            color: #e8ecff;
            min-height: 100vh;
            background: radial-gradient(circle at 20% 10%, #1a2140 0%, transparent 35%),
                        radial-gradient(circle at 80% 20%, #2a1548 0%, transparent 35%),
                        linear-gradient(180deg, var(--bg-start), var(--bg-end));
            overflow-x: hidden;
        }

        .app-shell {
            min-height: 100vh;
            position: relative;
            padding: 24px 14px 40px;
        }

        .search-stage {
            position: fixed;
            left: 50%;
            top: 38vh;
            transform: translate(-50%, -50%);
            width: min(760px, 94vw);
            z-index: 50;
            transition: top .8s ease, width .8s ease, transform .8s ease;
        }

        .stage-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            transition: gap .4s ease;
        }

        .logo-wrapper {
            position: relative;
            width: clamp(150px, 22vw, 210px);
            aspect-ratio: 1;
            display: grid;
            place-items: center;
            transition: transform .8s ease;
        }

        .logo-ring {
            position: absolute;
            inset: 0;
            border-radius: 999px;
            background: conic-gradient(from 0deg, #5fd7ff, #87f0ff, #7ea9ff, #c26eff, #ff8fea, #5fd7ff);
            filter: drop-shadow(0 0 18px rgba(132, 198, 255, .75));
            mask: radial-gradient(circle, transparent 55%, #000 58%);
            -webkit-mask: radial-gradient(circle, transparent 55%, #000 58%);
            opacity: .95;
            transition: transform .8s ease, opacity .4s ease;
        }

        .logo-gem {
            position: absolute;
            width: 38px;
            height: 38px;
            transform: rotate(45deg);
            border: 1px solid rgba(143, 219, 255, .8);
            background: linear-gradient(135deg, rgba(123, 225, 255, .55), rgba(205, 126, 255, .45));
            box-shadow: 0 0 14px rgba(132, 198, 255, .6);
        }

        .logo-gem:nth-child(2) { top: -8px; left: 50%; transform: translateX(-50%) rotate(45deg); }
        .logo-gem:nth-child(3) { top: 19%; right: -4px; }
        .logo-gem:nth-child(4) { bottom: 19%; right: -4px; }
        .logo-gem:nth-child(5) { bottom: -8px; left: 50%; transform: translateX(-50%) rotate(45deg); }
        .logo-gem:nth-child(6) { bottom: 19%; left: -4px; }
        .logo-gem:nth-child(7) { top: 19%; left: -4px; }

        .logo-core {
            width: 66%;
            aspect-ratio: 1;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #223968, #121a35 70%);
            border: 1px solid rgba(150, 210, 255, .4);
            display: grid;
            place-items: center;
            box-shadow: inset 0 0 24px rgba(148, 199, 255, .28), 0 0 22px rgba(122, 156, 255, .35);
            z-index: 2;
        }

        .logo-text {
            font-size: clamp(1.8rem, 5vw, 2.8rem);
            letter-spacing: .4px;
            font-weight: 800;
            background: linear-gradient(90deg, #8cf4ff, #c68bff);
            -webkit-background-clip: text;
            color: transparent;
        }

        .search-shell {
            width: min(700px, 92vw);
            border-radius: 999px;
            border: 1px solid rgba(140, 201, 255, .36);
            background: rgba(8, 12, 31, .88);
            box-shadow: 0 10px 30px rgba(40, 92, 193, .2), inset 0 0 0 1px rgba(255, 255, 255, .08);
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px 10px 16px;
            transition: transform .6s ease, opacity .6s ease;
            transform-origin: center;
        }

        .search-shell input {
            flex: 1;
            border: 0;
            outline: 0;
            background: transparent;
            color: #eaf6ff;
            font-size: 1rem;
        }

        .search-shell input::placeholder { color: #9db2d1; }

        .send-btn {
            border: 0;
            border-radius: 999px;
            background: linear-gradient(90deg, #58cfff, #a26eff);
            color: #031026;
            font-weight: 700;
            padding: 10px 20px;
            cursor: pointer;
            transition: transform .2s ease, filter .2s ease;
        }
        .send-btn:hover { filter: brightness(1.08); }
        .send-btn:active { transform: scale(.97); }

        .status-label {
            text-transform: uppercase;
            letter-spacing: .18em;
            font-size: .72rem;
            color: rgba(165, 190, 226, .85);
        }

        .state-idle .search-stage { top: 38vh; }

        .state-consume .search-shell {
            transform: scaleX(.04);
            opacity: 0;
            pointer-events: none;
        }
        .state-consume .logo-wrapper { transform: scale(1.18); }

        .state-loading .search-stage { top: 50vh; }
        .state-loading .search-shell {
            opacity: 0;
            transform: scale(.04);
            pointer-events: none;
        }
        .state-loading .logo-wrapper { transform: scale(1.3); }
        .state-loading .status-label { opacity: 1; }
        .state-loading .logo-ring { animation: spin-ring 1.1s linear infinite; }

        .state-results .search-stage {
            top: 20px;
            transform: translateX(-50%);
            width: min(1050px, 96vw);
        }
        .state-results .stage-content {
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }
        .state-results .search-shell {
            order: 1;
            flex: 1;
            max-width: 860px;
            opacity: 1;
            transform: scale(1);
        }
        .state-results .logo-wrapper {
            order: 2;
            width: 96px;
            transform: scale(.62);
            transform-origin: center;
        }
        .state-results .logo-gem { opacity: .78; }

        @keyframes spin-ring { to { transform: rotate(360deg); } }

        .response-box {
            margin-top: 170px;
            background: var(--panel);
            border: 1px solid rgba(132, 187, 255, .25);
            border-radius: 16px;
            padding: 14px 18px;
            color: #d8e6ff;
            backdrop-filter: blur(6px);
        }

        .cards-grid {
            margin-top: 16px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 18px;
            padding-bottom: 26px;
        }

        .store-card {
            background: rgba(8, 12, 28, .86);
            border-radius: 14px;
            border: 1px solid rgba(145, 175, 221, .2);
            overflow: hidden;
            box-shadow: 0 12px 28px rgba(1, 4, 14, .45);
        }

        .store-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            color: white;
            font-weight: 700;
        }

        .store-items {
            max-height: 410px;
            overflow-y: auto;
        }

        .store-items li {
            list-style: none;
            display: flex;
            gap: 10px;
            padding: 10px 12px;
            border-top: 1px solid rgba(127, 155, 205, .14);
        }

        .store-items img {
            width: 46px;
            height: 46px;
            border-radius: 8px;
            object-fit: contain;
            background: white;
            padding: 3px;
        }

        .hidden { display: none !important; }

        @media (max-width: 760px) {
            .state-results .search-stage {
                top: 10px;
                width: 98vw;
            }
            .state-results .logo-wrapper {
                width: 78px;
                transform: scale(.58);
            }
            .search-shell { padding: 8px 8px 8px 12px; }
            .send-btn { padding: 8px 14px; }
            .response-box { margin-top: 145px; }
        }
    </style>
</head>
<body class="state-idle">
    <div class="app-shell">
        <header id="searchStage" class="search-stage">
            <div class="stage-content">
                <div class="logo-wrapper" aria-label="Logo MarIA">
                    <div class="logo-ring"></div>
                    <div class="logo-gem"></div>
                    <div class="logo-gem"></div>
                    <div class="logo-gem"></div>
                    <div class="logo-gem"></div>
                    <div class="logo-gem"></div>
                    <div class="logo-gem"></div>
                    <div class="logo-core">
                        <div class="logo-text">MarIA</div>
                    </div>
                </div>

                <div class="search-shell" id="searchShell">
                    <svg style="width:18px;height:18px;color:#95aed6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input type="text" id="userInput" placeholder="Buscar componente o producto..." autocomplete="off" onkeypress="handleKeyPress(event)">
                    <button class="send-btn" onclick="sendQuery()">Buscar</button>
                </div>

                <span id="statusLabel" class="status-label hidden">Analizando información…</span>
            </div>
        </header>

        <main class="w-full max-w-7xl mx-auto" style="padding-top: 150px;">
            <div id="resultBox" class="response-box hidden">
                <p id="responseText" class="m-0 text-sm md:text-base"></p>
            </div>
            <div id="cardsContainer" class="cards-grid"></div>
        </main>
    </div>

    <script>
        const body = document.body;
        const statusLabel = document.getElementById('statusLabel');

        function setUiState(state) {
            body.classList.remove('state-idle', 'state-consume', 'state-loading', 'state-results');
            body.classList.add(`state-${state}`);
            if (state === 'loading') {
                statusLabel.classList.remove('hidden');
            } else {
                statusLabel.classList.add('hidden');
            }
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendQuery();
        }

        async function sendQuery() {
            const input = document.getElementById('userInput');
            const resultBox = document.getElementById('resultBox');
            const responseText = document.getElementById('responseText');
            const cardsContainer = document.getElementById('cardsContainer');
            const message = input.value.trim();

            if (!message) return;

            input.blur();
            input.disabled = true;
            resultBox.classList.add('hidden');
            cardsContainer.innerHTML = '';

            setUiState('consume');
            await wait(430);
            setUiState('loading');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                responseText.textContent = data.reply || 'Proceso completado.';
                resultBox.classList.remove('hidden');
                setUiState('results');

                if (data.results) renderCards(data.results);
            } catch (error) {
                responseText.innerHTML = '<span style="color:#ff8f8f">Error de conexión con el servidor.</span>';
                resultBox.classList.remove('hidden');
                setUiState('results');
                console.error(error);
            } finally {
                input.disabled = false;
            }
        }

        function renderCards(resultadosAgrupados) {
            const container = document.getElementById('cardsContainer');

            for (const [nombreTienda, productos] of Object.entries(resultadosAgrupados)) {
                if (!productos || productos.length === 0) continue;

                let headerColor = '#334155';
                switch (nombreTienda) {
                    case 'Vistronica': headerColor = '#f97316'; break;
                    case 'Electronilab': headerColor = '#2563eb'; break;
                    case 'Zamux': headerColor = '#D2040F'; break;
                    case 'Sigma': headerColor = '#111827'; break;
                    case 'Mactronica': headerColor = '#1e3a8a'; break;
                    case 'Arca Electrónica': headerColor = '#ea580c'; break;
                    case 'Electrónica Plug and Play': headerColor = '#0d9488'; break;
                    case 'Electrosena': headerColor = '#9333ea'; break;
                    case 'Ja-Bots': headerColor = '#b91c1c'; break;
                }

                const itemsHTML = productos.map((p) => `
                    <li>
                        <img src="${p.imagen || 'https://via.placeholder.com/46?text=N/A'}" alt="img" loading="lazy">
                        <div style="min-width:0;flex:1;">
                            <a href="${p.url}" target="_blank" style="display:block;color:#ddebff;font-size:.86rem;font-weight:600;text-decoration:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.nombre}</a>
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px;gap:8px;">
                                <span style="font-size:.85rem;font-weight:700;color:#f1f5ff;">${p.precio}</span>
                                <span style="font-size:.65rem;padding:2px 8px;border-radius:999px;border:1px solid ${p.stock === 'Agotado' ? '#7f1d1d' : '#14532d'};color:${p.stock === 'Agotado' ? '#fecaca' : '#bbf7d0'};background:${p.stock === 'Agotado' ? 'rgba(127,29,29,.35)' : 'rgba(20,83,45,.35)'};">${p.stock || 'Stock?'}</span>
                            </div>
                        </div>
                    </li>
                `).join('');

                const card = `
                    <article class="store-card">
                        <div class="store-header" style="background:${headerColor};">
                            <span>${nombreTienda}</span>
                            <span style="font-size:.74rem;background:rgba(255,255,255,.2);padding:4px 8px;border-radius:8px;">${productos.length}</span>
                        </div>
                        <ul class="store-items">${itemsHTML}</ul>
                    </article>
                `;

                container.insertAdjacentHTML('beforeend', card);
            }
        }
    </script>
</body>
</html>